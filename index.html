<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinkCord - Chat with Friends</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(236, 72, 153, 0.3);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #ec4899 0%, #be185d 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin: 0 auto 10px;
            border: 3px solid white;
        }

        .user-details {
            text-align: center;
        }

        .username {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-rank {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .online-users {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .user-item-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 12px;
            border: 2px solid white;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-item-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fdf2f8;
        }

        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 2px solid #fce7f3;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 20px;
            font-weight: bold;
            color: #be185d;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(236, 72, 153, 0.4);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(180deg, #fdf2f8 0%, #fce7f3 100%);
        }

        .message {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ec4899, #be185d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-right: 12px;
        }

        .message-info {
            flex: 1;
        }

        .message-author {
            font-weight: bold;
            color: #be185d;
            margin-right: 10px;
        }

        .message-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .message-content {
            color: #374151;
            line-height: 1.5;
        }

        .chat-input-container {
            background: white;
            padding: 20px;
            border-top: 2px solid #fce7f3;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #fce7f3;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(236, 72, 153, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #fce7f3;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #be185d;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #be185d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #fce7f3;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #fce7f3;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            background: white;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(236, 72, 153, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: white;
            border: 2px solid #fce7f3;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 20px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .emoji-btn:hover {
            background: #fce7f3;
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #9ca3af;
            font-size: 14px;
        }

        .typing-dots {
            display: inline-block;
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 999;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-menu-btn {
                display: block;
                background: linear-gradient(135deg, #ec4899, #be185d);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Status indicators */
        .status-online { background: #10b981; }
        .status-away { background: #f59e0b; }
        .status-busy { background: #ef4444; }
        .status-offline { background: #6b7280; }

        /* Rank colors */
        .rank-admin { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .rank-moderator { background: linear-gradient(45deg, #8b5cf6, #7c3aed); }
        .rank-vip { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .rank-member { background: linear-gradient(45deg, #10b981, #059669); }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ec4899, #be185d);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #be185d, #9d174d);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">üíñ PinkCord</div>
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">U</div>
                    <div class="user-details">
                        <div class="username" id="currentUsername">Guest</div>
                        <div class="user-rank" id="currentUserRank">Member</div>
                    </div>
                </div>
            </div>

            <div class="online-users">
                <div class="section-title">Online Friends</div>
                <div id="onlineUsersList">
                    <!-- Online users will be populated here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <div>
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <span class="chat-title" id="chatTitle">üí¨ General Chat</span>
                </div>
                <div class="chat-actions">
                    <button class="action-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                    <button class="action-btn" onclick="openUserProfile()">üë§ Profile</button>
                    <button class="action-btn" onclick="toggleEmojiPicker()">üòä</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be populated here -->
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <span id="typingUser">Someone</span> is typing<span class="typing-dots">...</span>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type your message..." maxlength="500">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>

            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-grid" id="emojiGrid">
                    <!-- Emojis will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <form onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="settingsUsername" maxlength="20" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" class="form-input" id="settingsDisplayName" maxlength="30">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="settingsStatus">
                        <option value="online">üü¢ Online</option>
                        <option value="away">üü° Away</option>
                        <option value="busy">üî¥ Busy</option>
                        <option value="offline">‚ö´ Offline</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Theme Color</label>
                    <select class="form-select" id="settingsTheme">
                        <option value="pink">üíñ Pink (Default)</option>
                        <option value="purple">üíú Purple</option>
                        <option value="blue">üíô Blue</option>
                        <option value="green">üíö Green</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë§ User Profile</h2>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <div id="profileContent">
                <!-- Profile content will be populated here -->
            </div>
        </div>
    </div>

    <!-- DM Modal -->
    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dmTitle">üí¨ Direct Message</h2>
                <button class="close-btn" onclick="closeModal('dmModal')">&times;</button>
            </div>
            <div class="chat-messages" id="dmMessages" style="height: 300px; margin-bottom: 20px;">
                <!-- DM messages will be populated here -->
            </div>
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="dmInput" placeholder="Type your direct message...">
                <button class="send-btn" onclick="sendDM()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = {
            id: generateUserId(),
            username: 'Guest',
            displayName: 'Guest User',
            status: 'online',
            rank: 'member',
            joinDate: new Date().toISOString(),
            avatar: 'U'
        };

        let messages = [];
        let onlineUsers = [];
        let dmConversations = {};
        let currentDMUser = null;
        let typingTimeout = null;
        let isTyping = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            initializeEmojis();
            loadMessages();
            loadOnlineUsers();
            updateUI();
            startHeartbeat();
            
            // Add event listeners
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
                handleTyping();
            });

            document.getElementById('dmInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendDM();
                }
            });

            // Load welcome message
            if (messages.length === 0) {
                addSystemMessage('Welcome to PinkCord! üíñ Start chatting with your friends!');
            }
        });

        // Utility functions
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        function generateAvatar(username) {
            return username.charAt(0).toUpperCase();
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // User management
        function loadUserData() {
            const savedUser = localStorage.getItem('pinkcord_user');
            if (savedUser) {
                currentUser = { ...currentUser, ...JSON.parse(savedUser) };
            }
            updateCurrentUserDisplay();
        }

        function saveUserData() {
            localStorage.setItem('pinkcord_user', JSON.stringify(currentUser));
        }

        function updateCurrentUserDisplay() {
            document.getElementById('currentUsername').textContent = currentUser.displayName || currentUser.username;
            document.getElementById('currentUserAvatar').textContent = generateAvatar(currentUser.username);
            document.getElementById('currentUserRank').textContent = currentUser.rank.charAt(0).toUpperCase() + currentUser.rank.slice(1);
            
            // Update rank styling
            const avatar = document.getElementById('currentUserAvatar');
            avatar.className = `user-avatar rank-${currentUser.rank}`;
        }

        // Online users management
        function loadOnlineUsers() {
            const saved = localStorage.getItem('pinkcord_online_users');
            if (saved) {
                onlineUsers = JSON.parse(saved);
            }
            
            // Add current user if not already in list
            const existingUser = onlineUsers.find(u => u.id === currentUser.id);
            if (!existingUser) {
                onlineUsers.push({
                    ...currentUser,
                    lastSeen: new Date().toISOString()
                });
            } else {
                // Update existing user
                Object.assign(existingUser, currentUser);
                existingUser.lastSeen = new Date().toISOString();
            }
            
            saveOnlineUsers();
            updateOnlineUsersList();
        }

        function saveOnlineUsers() {
            localStorage.setItem('pinkcord_online_users', JSON.stringify(onlineUsers));
        }

        function updateOnlineUsersList() {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';
            
            onlineUsers.forEach(user => {
                if (user.id === currentUser.id) return; // Don't show current user
                
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.onclick = () => openDM(user);
                
                userElement.innerHTML = `
                    <div class="user-item-avatar rank-${user.rank}">${generateAvatar(user.username)}</div>
                    <div class="user-item-info">
                        <div class="user-item-name">${user.displayName || user.username}</div>
                        <div class="user-item-status">${user.status}</div>
                    </div>
                    <div class="online-indicator status-${user.status}"></div>
                `;
                
                container.appendChild(userElement);
            });
        }

        // Message management
        function loadMessages() {
            const saved = localStorage.getItem('pinkcord_messages');
            if (saved) {
                messages = JSON.parse(saved);
                displayMessages();
            }
        }

        function saveMessages() {
            localStorage.setItem('pinkcord_messages', JSON.stringify(messages));
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            const message = {
                id: Date.now(),
                author: currentUser.username,
                displayName: currentUser.displayName || currentUser.username,
                content: content,
                timestamp: new Date().toISOString(),
                avatar: generateAvatar(currentUser.username),
                rank: currentUser.rank
            };
            
            messages.push(message);
            saveMessages();
            displayMessages();
            input.value = '';
            
            // Stop typing indicator
            clearTimeout(typingTimeout);
            isTyping = false;
            updateTypingIndicator();
            
            showNotification('Message sent! üíñ');
        }

        function addSystemMessage(content) {
            const message = {
                id: Date.now(),
                author: 'System',
                displayName: 'PinkCord Bot',
                content: content,
                timestamp: new Date().toISOString(),
                avatar: 'ü§ñ',
                rank: 'admin',
                isSystem: true
            };
            
            messages.push(message);
            saveMessages();
            displayMessages();
        }

        function displayMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            messages.slice(-50).forEach(message => { // Show last 50 messages
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar rank-${message.rank}">${message.avatar}</div>
                        <div class="message-info">
                            <span class="message-author">${message.displayName}</span>
                            <span class="message-time">${formatTime(message.timestamp)}</span>
                        </div>
                    </div>
                    <div class="message-content">${escapeHtml(message.content)}</div>
                `;
                
                container.appendChild(messageElement);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Typing indicator
        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                updateTypingIndicator();
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                updateTypingIndicator();
            }, 2000);
        }

        function updateTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (isTyping) {
                document.getElementById('typingUser').textContent = currentUser.displayName || currentUser.username;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Direct Messages
        function openDM(user) {
            currentDMUser = user;
            document.getElementById('dmTitle').textContent = `üí¨ ${user.displayName || user.username}`;
            loadDMMessages(user.id);
            document.getElementById('dmModal').style.display = 'block';
        }

        function loadDMMessages(userId) {
            const conversationKey = [currentUser.id, userId].sort().join('_');
            const saved = localStorage.getItem(`pinkcord_dm_${conversationKey}`);
            const conversation = saved ? JSON.parse(saved) : [];
            
            const container = document.getElementById('dmMessages');
            container.innerHTML = '';
            
            conversation.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar rank-${message.rank}">${message.avatar}</div>
                        <div class="message-info">
                            <span class="message-author">${message.displayName}</span>
                            <span class="message-time">${formatTime(message.timestamp)}</span>
                        </div>
                    </div>
                    <div class="message-content">${escapeHtml(message.content)}</div>
                `;
                
                container.appendChild(messageElement);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function sendDM() {
            const input = document.getElementById('dmInput');
            const content = input.value.trim();
            
            if (!content || !currentDMUser) return;
            
            const message = {
                id: Date.now(),
                author: currentUser.username,
                displayName: currentUser.displayName || currentUser.username,
                content: content,
                timestamp: new Date().toISOString(),
                avatar: generateAvatar(currentUser.username),
                rank: currentUser.rank,
                senderId: currentUser.id
            };
            
            const conversationKey = [currentUser.id, currentDMUser.id].sort().join('_');
            const saved = localStorage.getItem(`pinkcord_dm_${conversationKey}`);
            const conversation = saved ? JSON.parse(saved) : [];
            
            conversation.push(message);
            localStorage.setItem(`pinkcord_dm_${conversationKey}`, JSON.stringify(conversation));
            
            loadDMMessages(currentDMUser.id);
            input.value = '';
            
            showNotification(`DM sent to ${currentDMUser.displayName || currentDMUser.username}! üíå`);
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsUsername').value = currentUser.username;
            document.getElementById('settingsDisplayName').value = currentUser.displayName || '';
            document.getElementById('settingsStatus').value = currentUser.status;
            document.getElementById('settingsModal').style.display = 'block';
        }

        function saveSettings(event) {
            event.preventDefault();
            
            const newUsername = document.getElementById('settingsUsername').value.trim();
            const newDisplayName = document.getElementById('settingsDisplayName').value.trim();
            const newStatus = document.getElementById('settingsStatus').value;
            
            if (!newUsername) {
                alert('Username is required!');
                return;
            }
            
            currentUser.username = newUsername;
            currentUser.displayName = newDisplayName;
            currentUser.status = newStatus;
            currentUser.avatar = generateAvatar(newUsername);
            
            saveUserData();
            updateCurrentUserDisplay();
            loadOnlineUsers(); // Update in online users list
            
            closeModal('settingsModal');
            showNotification('Settings saved! ‚ú®');
            
            addSystemMessage(`${currentUser.displayName || currentUser.username} updated their profile!`);
        }

        // Profile
        function openUserProfile() {
            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar rank-${currentUser.rank}" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px;">${generateAvatar(currentUser.username)}</div>
                    <h3>${currentUser.displayName || currentUser.username}</h3>
                    <p style="color: #9ca3af;">@${currentUser.username}</p>
                </div>
                <div class="form-group">
                    <strong>Rank:</strong> ${currentUser.rank.charAt(0).toUpperCase() + currentUser.rank.slice(1)}
                </div>
                <div class="form-group">
                    <strong>Status:</strong> ${currentUser.status.charAt(0).toUpperCase() + currentUser.status.slice(1)}
                </div>
                <div class="form-group">
                    <strong>Joined:</strong> ${new Date(currentUser.joinDate).toLocaleDateString()}
                </div>
                <div class="form-group">
                    <strong>Messages Sent:</strong> ${messages.filter(m => m.author === currentUser.username).length}
                </div>
            `;
            document.getElementById('profileModal').style.display = 'block';
        }

        // Emoji picker
        function initializeEmojis() {
            const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'];
            
            const grid = document.getElementById('emojiGrid');
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-btn';
                button.textContent = emoji;
                button.onclick = () => insertEmoji(emoji);
                grid.appendChild(button);
            });
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').style.display = 'none';
        }

        // Modal management
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Mobile menu
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Heartbeat to keep user active
        function startHeartbeat() {
            setInterval(() => {
                const userIndex = onlineUsers.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    onlineUsers[userIndex].lastSeen = new Date().toISOString();
                    saveOnlineUsers();
                }
            }, 30000); // Update every 30 seconds
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            const emojiPicker = document.getElementById('emojiPicker');
            if (!event.target.closest('.emoji-picker') && !event.target.closest('.action-btn')) {
                emojiPicker.style.display = 'none';
            }
        };

        // Add some demo users for testing
        function addDemoUsers() {
            const demoUsers = [
                { id: 'demo1', username: 'alice', displayName: 'Alice Wonder', status: 'online', rank: 'moderator' },
                { id: 'demo2', username: 'bob', displayName: 'Bob Builder', status: 'away', rank: 'vip' },
                { id: 'demo3', username: 'charlie', displayName: 'Charlie Brown', status: 'busy', rank: 'member' }
            ];
            
            demoUsers.forEach(user => {
                if (!onlineUsers.find(u => u.id === user.id)) {
                    onlineUsers.push({
                        ...user,
                        joinDate: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        avatar: generateAvatar(user.username)
                    });
                }
            });
            
            saveOnlineUsers();
            updateOnlineUsersList();
        }

        // Initialize demo users after a short delay
        setTimeout(addDemoUsers, 1000);

        // Update UI periodically
        setInterval(updateUI, 5000);

        function updateUI() {
            updateOnlineUsersList();
            displayMessages();
        }
    </script>
</body>
</html>
